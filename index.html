<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARinvitation - Buku Tamu Digital</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue JS -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- QRCode JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        
        [v-cloak] { display: none; }
        
        .transition-theme { transition: all 0.5s ease; }

        #qrcode-container img {
            margin: 0 auto;
            border: 8px solid white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .slide-up-enter-active, .slide-up-leave-active {
            transition: all 0.3s ease-out;
        }
        .slide-up-enter-from { transform: translateY(20px); opacity: 0; }
        .slide-up-leave-to { transform: translateY(-20px); opacity: 0; }

        @media print {
            header, nav, .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; color: black !important; }
            .qr-card-print { border: none !important; shadow: none !important; }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="transition-theme">
    <div id="app" v-cloak :class="[theme.secondary, theme.text, 'min-h-screen relative']">
        
        <!-- NOTIFIKASI -->
        <transition name="slide-up">
            <div v-if="showNotification" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3">
                <i data-lucide="check-circle" class="w-5 h-5"></i>
                <span class="font-bold">Data Berhasil Disimpan!</span>
            </div>
        </transition>

        <!-- HEADER -->
        <header v-if="!isSelfCheckIn" :class="[theme.primary, 'text-white shadow-lg sticky top-0 z-50 transition-theme no-print']">
            <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-slate-900 font-bold">AR</div>
                    <span class="text-xl font-bold tracking-tight">{{ weddingInfo.logoText }}</span>
                </div>

                <nav class="hidden md:flex space-x-6">
                    <button @click="activeTab = 'beranda'" class="flex items-center space-x-1 hover:opacity-80" :class="{'border-b-2 border-white': activeTab === 'beranda'}">
                        <i data-lucide="home" class="w-4 h-4"></i> <span>Beranda</span>
                    </button>
                    <button @click="activeTab = 'registrasi'" class="flex items-center space-x-1 hover:opacity-80" :class="{'border-b-2 border-white': activeTab === 'registrasi'}">
                        <i data-lucide="user-plus" class="w-4 h-4"></i> <span>Registrasi</span>
                    </button>
                    <button @click="activeTab = 'database'" class="flex items-center space-x-1 hover:opacity-80" :class="{'border-b-2 border-white': activeTab === 'database'}">
                        <i data-lucide="database" class="w-4 h-4"></i> <span>Laporan Lengkap</span>
                    </button>
                    <button @click="activeTab = 'pengaturan'" class="flex items-center space-x-1 hover:opacity-80" :class="{'border-b-2 border-white': activeTab === 'pengaturan'}">
                        <i data-lucide="settings" class="w-4 h-4"></i> <span>Pengaturan</span>
                    </button>
                </nav>
            </div>
        </header>

        <main class="max-w-6xl mx-auto p-4 md:p-8">
            
            <!-- MODE CHECK-IN MANDIRI -->
            <section v-if="isSelfCheckIn" class="animate-fadeIn py-10">
                <div class="max-w-xl mx-auto">
                    <div class="text-center mb-10">
                        <h1 class="text-3xl font-serif mb-2">{{ weddingInfo.mempelai }}</h1>
                        <p class="text-slate-500 italic">Selamat Datang di Acara Pernikahan Kami</p>
                    </div>
                    
                    <div :class="[theme.card, 'p-8 rounded-2xl shadow-xl border']">
                        <h2 class="text-xl font-bold mb-6 text-center">Formulir Buku Tamu</h2>
                        <form @submit.prevent="submitGuest" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-1">Nama Lengkap</label>
                                <input v-model="form.nama" required class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Ketik nama..." />
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">WhatsApp</label>
                                    <input v-model="form.hp" required type="tel" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="08xx..." />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Kategori</label>
                                    <select v-model="form.kategori" class="w-full p-3 rounded-lg border border-slate-200 outline-none bg-white">
                                        <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Alamat / Instansi</label>
                                <input v-model="form.alamat" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Asal kota/instansi..." />
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-1">Ucapan & Doa</label>
                                <textarea v-model="form.ucapan" rows="3" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Tulis doa restu..."></textarea>
                            </div>
                            <button type="submit" :class="[theme.button, 'w-full py-4 text-white font-bold rounded-xl shadow-lg']">
                                Kirim Kedatangan
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- BERANDA -->
            <section v-if="!isSelfCheckIn && activeTab === 'beranda'" class="space-y-8 animate-fadeIn no-print">
                <div :class="[theme.card, 'p-10 rounded-3xl text-center shadow-xl border relative overflow-hidden transition-theme']">
                    <h2 :class="[theme.accent, 'text-sm uppercase tracking-[0.3em] mb-4 font-semibold']">Wedding Reception</h2>
                    <h1 class="text-5xl md:text-7xl font-serif mb-6">{{ weddingInfo.mempelai }}</h1>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-4 text-lg">
                        <span class="flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5"></i> {{ weddingInfo.tanggal }}</span>
                        <span class="hidden md:block">|</span>
                        <span class="flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5"></i> {{ weddingInfo.lokasi }}</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div :class="[theme.card, 'p-6 rounded-2xl shadow-md border transition-theme']">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg flex items-center gap-2"><i data-lucide="users" :class="theme.accent"></i> Kapasitas</h3>
                            <span class="text-2xl font-black">{{ maxGuests }}</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-4 overflow-hidden">
                            <div :class="[theme.primary, 'h-full transition-all duration-1000']" :style="{ width: (guests.length / maxGuests * 100) + '%' }"></div>
                        </div>
                        <p class="mt-2 text-sm text-slate-500 text-right">Terisi: {{ guests.length }} Tamu</p>
                    </div>

                    <div :class="[theme.card, 'md:col-span-2 p-6 rounded-2xl shadow-md border transition-theme']">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" :class="theme.accent"></i> Ringkasan Kedatangan</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div v-for="cat in statsPerCategory" :key="cat.name" class="bg-black bg-opacity-5 p-3 rounded-xl border border-black border-opacity-5">
                                <p class="text-[10px] text-slate-500 font-bold uppercase">{{ cat.name }}</p>
                                <p class="text-xl font-bold">{{ cat.count }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- REGISTRASI + QR + DATABASE TERINTEGRASI -->
            <section v-if="!isSelfCheckIn && activeTab === 'registrasi'" class="space-y-8 animate-fadeIn">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- FORM INPUT (SISI KIRI) -->
                    <div class="lg:col-span-2 space-y-6">
                        <div :class="[theme.card, 'p-8 rounded-2xl shadow-xl border transition-theme no-print']">
                            <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                                <i data-lucide="edit-3" :class="theme.accent"></i> Registrasi Tamu
                            </h2>
                            <form @submit.prevent="submitGuest" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Nama Tamu</label>
                                    <input v-model="form.nama" required class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Ketik nama lengkap..." />
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold mb-1">WhatsApp</label>
                                        <input v-model="form.hp" required type="tel" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="08xx..." />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold mb-1">Kategori</label>
                                        <select v-model="form.kategori" class="w-full p-3 rounded-lg border border-slate-200 outline-none bg-white">
                                            <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Alamat / Instansi</label>
                                    <input v-model="form.alamat" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Kota atau asal instansi..." />
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-1">Ucapan & Doa</label>
                                    <textarea v-model="form.ucapan" rows="3" class="w-full p-3 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-slate-400" placeholder="Tuliskan doa restu..."></textarea>
                                </div>
                                <button type="submit" :class="[theme.button, 'w-full py-4 text-white font-bold rounded-xl shadow-lg transition-all active:scale-95']">
                                    Simpan Kedatangan
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- QR CODE (SISI KANAN) -->
                    <div class="space-y-6">
                        <div :class="[theme.card, 'qr-card-print p-8 rounded-2xl shadow-xl border text-center transition-theme relative overflow-hidden flex flex-col items-center']">
                            <h3 class="text-xl font-bold mb-2">Self Check-in QR</h3>
                            <p class="text-[10px] text-slate-500 mb-6 font-medium uppercase tracking-widest no-print">Tampilkan di meja tamu agar mereka bisa registrasi mandiri</p>
                            
                            <!-- PEMILIH KATEGORI AKTIF -->
                            <div class="w-full mb-6 no-print">
                                <label class="block text-left text-[10px] font-bold text-slate-400 uppercase mb-1 px-1">Pilih Kategori QR</label>
                                <select v-model="qrKategori" @change="generateQRCode" class="w-full p-3 border rounded-xl bg-white font-bold outline-none focus:ring-2 focus:ring-slate-200">
                                    <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                                </select>
                            </div>

                            <div class="bg-slate-50 p-4 rounded-2xl inline-block mx-auto border border-slate-200 mb-6">
                                <div id="qrcode-container" class="bg-white p-2 rounded-lg"></div>
                                <p class="mt-4 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Kategori: <span class="text-slate-800">{{ qrKategori }}</span></p>
                            </div>
                            
                            <div class="w-full no-print">
                                <button @click="window.print()" :class="[theme.button, 'w-full py-3 text-white rounded-xl flex items-center justify-center gap-2 font-bold shadow-md active:scale-95 transition-all']">
                                    <i data-lucide="printer" class="w-4 h-4"></i> Cetak QR
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DATABASE DI MENU REGISTRASI -->
                <div :class="[theme.card, 'p-6 rounded-2xl shadow-lg border no-print mt-8']">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="list" class="w-5 h-5 text-slate-400"></i> Database Kedatangan Terkini
                        </h3>
                        <div class="flex items-center gap-2">
                            <select v-model="regFilter" class="text-xs p-2 border rounded-lg bg-white outline-none">
                                <option value="all">Semua Kategori</option>
                                <option v-for="cat in categories" :key="cat" :value="cat">{{ cat }}</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-400 font-bold uppercase text-[10px]">
                                <tr>
                                    <th class="p-4">Waktu</th>
                                    <th class="p-4">Nama Tamu</th>
                                    <th class="p-4">Kategori</th>
                                    <th class="p-4">Ucapan</th>
                                    <th class="p-4 text-center">Hapus</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="g in paginatedRegGuests" :key="g.id" class="hover:bg-slate-50">
                                    <td class="p-4 text-slate-400 font-mono text-xs">{{ g.time }}</td>
                                    <td class="p-4 font-bold">{{ g.nama }}</td>
                                    <td class="p-4"><span :class="[theme.primary, 'px-2 py-0.5 rounded text-[9px] text-white font-bold uppercase']">{{ g.kategori }}</span></td>
                                    <td class="p-4 text-slate-500 italic truncate max-w-[200px]">{{ g.ucapan || '-' }}</td>
                                    <td class="p-4 text-center">
                                        <button @click="deleteGuest(g.id)" class="text-red-300 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="paginatedRegGuests.length === 0">
                                    <td colspan="5" class="p-8 text-center text-slate-300 italic text-xs">Belum ada data kedatangan.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- LAPORAN LENGKAP ADMIN -->
            <section v-if="!isSelfCheckIn && activeTab === 'database'" class="space-y-6 animate-fadeIn no-print">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <h2 class="text-2xl font-bold">Laporan Kedatangan</h2>
                    <div class="flex gap-2">
                        <button @click="exportToPDF" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-red-700 text-sm font-bold shadow-md">
                            <i data-lucide="file-down" class="w-4 h-4"></i> Cetak PDF (Grup Kategori)
                        </button>
                    </div>
                </div>

                <div class="flex overflow-x-auto pb-2 gap-2 no-scrollbar border-b border-slate-100">
                    <button @click="dbFilter = 'all'" :class="[dbFilter === 'all' ? theme.primary + ' text-white' : 'bg-white border text-slate-500', 'px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all']">
                        Semua ({{ guests.length }})
                    </button>
                    <button v-for="cat in statsPerCategory" :key="cat.name" @click="dbFilter = cat.name" :class="[dbFilter === cat.name ? theme.primary + ' text-white' : 'bg-white border text-slate-500', 'px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap shadow-sm transition-all']">
                        {{ cat.name }} ({{ cat.count }})
                    </button>
                </div>

                <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold">
                            <tr>
                                <th class="p-4 w-12">No</th>
                                <th class="p-4">Waktu</th>
                                <th class="p-4">Nama Tamu</th>
                                <th class="p-4">WhatsApp</th>
                                <th class="p-4">Kategori</th>
                                <th class="p-4 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(g, index) in filteredGuests" :key="g.id" class="hover:bg-slate-50 transition-colors">
                                <td class="p-4 text-xs font-bold text-slate-300">{{ index + 1 }}</td>
                                <td class="p-4 text-xs text-slate-400 whitespace-nowrap">{{ g.time }}</td>
                                <td class="p-4 font-bold">{{ g.nama }}</td>
                                <td class="p-4 text-sm font-mono text-slate-600">{{ g.hp }}</td>
                                <td class="p-4"><span :class="[theme.primary, 'px-2 py-0.5 rounded text-[10px] text-white font-bold uppercase']">{{ g.kategori }}</span></td>
                                <td class="p-4 text-center">
                                    <button @click="deleteGuest(g.id)" class="text-red-300 hover:text-red-600 transition-all p-1">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- PENGATURAN -->
            <section v-if="!isSelfCheckIn && activeTab === 'pengaturan'" class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fadeIn no-print">
                <div :class="[theme.card, 'p-8 rounded-2xl shadow-xl border transition-theme space-y-4']">
                    <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="settings" :class="theme.accent"></i> Kontrol Data</h3>
                    <div>
                        <label class="block text-sm font-bold mb-1">Target Kuota Tamu</label>
                        <input type="number" v-model="maxGuests" class="w-full p-2 border rounded-lg outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Manajemen Kategori Sistem</label>
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="catInput" class="flex-1 p-2 border rounded-lg outline-none" placeholder="Nama kategori baru...">
                            <button @click="addCategory" :class="[theme.primary, 'text-white px-4 rounded-lg font-bold']">Tambah</button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span v-for="cat in categories" :key="cat" class="bg-slate-100 px-3 py-1 rounded-full text-[11px] font-bold flex items-center gap-2 border">
                                {{ cat }} <button @click="removeCategory(cat)" class="text-red-500 font-black">Ã—</button>
                            </span>
                        </div>
                    </div>
                </div>

                <div :class="[theme.card, 'p-8 rounded-2xl shadow-xl border transition-theme space-y-4']">
                    <h3 class="text-xl font-bold flex items-center gap-2"><i data-lucide="palette" :class="theme.accent"></i> Tema Aplikasi</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <button v-for="(t, key) in themeOptions" :key="key" @click="currentTheme = key" 
                            :class="[currentTheme === key ? 'border-slate-800 bg-slate-50' : 'border-transparent bg-white', 'p-4 rounded-xl border-2 flex items-center gap-4 transition-all']">
                            <div :class="[t.primary, 'w-6 h-6 rounded-full shadow-inner']" :style="t.customStyle"></div>
                            <span class="font-bold text-sm">{{ t.name }}</span>
                        </button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;

    createApp({
        setup() {
            // --- KONFIGURASI DATABASE ---
            // Ganti URL di bawah ini dengan URL Web App dari Google Apps Script kamu
            const DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwZs8Pkk1dPnIeTuIwcPLa01_d7zUhknHiQCgUrYggXTsaFQRuTvw2X9bXuGCidJ9J0Jg/exec';

            const activeTab = ref('beranda');
            const dbFilter = ref('all');
            const regFilter = ref('all');
            const guests = ref([]);
            const maxGuests = ref(500);
            const currentTheme = ref('modern');
            const categories = ref(['Keluarga', 'Teman', 'VVIP', 'Rekan Kerja']);
            const showNotification = ref(false);
            const isSelfCheckIn = ref(false);
            
            const form = ref({ nama: '', hp: '', alamat: '', kategori: 'Keluarga', ucapan: '' });

            const weddingInfo = {
                mempelai: "Andi & Rina",
                tanggal: "12 Desember 2025",
                lokasi: "Hotel Mulia, Senayan",
                logoText: "AR Wedding"
            };

            const themeOptions = {
                modern: { name: 'Dark Onyx', primary: 'bg-slate-900', secondary: 'bg-white', accent: 'text-slate-900', button: 'bg-slate-800 hover:bg-slate-700', card: 'bg-white', text: 'text-slate-800' },
                romantic: { name: 'Blush Pink', primary: 'bg-rose-500', secondary: 'bg-rose-50', accent: 'text-rose-600', button: 'bg-rose-600 hover:bg-rose-500', card: 'bg-white', text: 'text-rose-900' },
                luxury: { name: 'Royal Amber', primary: 'bg-amber-800', secondary: 'bg-stone-50', accent: 'text-amber-800', button: 'bg-amber-800 hover:bg-amber-700', card: 'bg-white', text: 'text-stone-900' }
            };

            const theme = computed(() => themeOptions[currentTheme.value]);

            const statsPerCategory = computed(() => {
                return categories.value.map(c => ({ name: c, count: guests.value.filter(g => g.kategori === c).length }));
            });

            const filteredGuests = computed(() => {
                if (dbFilter.value === 'all') return guests.value;
                return guests.value.filter(g => g.kategori === dbFilter.value);
            });

            const paginatedRegGuests = computed(() => {
                const filtered = regFilter.value === 'all' 
                    ? guests.value 
                    : guests.value.filter(g => g.kategori === regFilter.value);
                return filtered.slice(0, 10); 
            });

            // --- FUNGSI AMBIL DATA DARI DATABASE ---
            const loadGuests = async () => {
                try {
                    const response = await fetch(DATABASE_URL);
                    const data = await response.json();
                    // Map data dan pastikan ada ID untuk fungsi hapus di UI
                    guests.value = data.reverse().map(g => ({
                        ...g,
                        id: g.id || Date.now() + Math.random()
                    }));
                } catch (e) {
                    console.error("Gagal memuat data dari database.");
                }
            };

            const generateQRCode = () => {
                nextTick(() => {
                    const container = document.getElementById("qrcode-container");
                    if (!container) return;
                    container.innerHTML = "";
                    const currentUrl = window.location.href.split('?')[0];
                    const targetUrl = `${currentUrl}?mode=checkin`;
                    
                    new QRCode(container, {
                        text: targetUrl,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                });
            };

            // --- FUNGSI SIMPAN DATA (UPDATE) ---
            const submitGuest = async () => {
                const newGuest = {
                    nama: form.value.nama,
                    hp: form.value.hp,
                    alamat: form.value.alamat,
                    kategori: form.value.kategori,
                    ucapan: form.value.ucapan,
                    time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
                };

                try {
                    // Simpan ke UI secara lokal dulu (supaya cepat)
                    guests.value.unshift({ id: Date.now(), ...newGuest });

                    // Kirim ke Google Sheets
                    await fetch(DATABASE_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(newGuest)
                    });
                    
                    // Reset Form & Notif
                    form.value = { nama: '', hp: '', alamat: '', kategori: 'Keluarga', ucapan: '' };
                    showNotification.value = true;
                    setTimeout(() => { showNotification.value = false; }, 3000);
                    nextTick(() => lucide.createIcons());
                } catch (e) {
                    alert("Koneksi bermasalah, data mungkin tidak tersimpan di database.");
                }
            };

            const deleteGuest = (id) => { 
                if(confirm("Hapus tamu dari daftar tampilan? (Data di Google Sheets tetap ada)")) {
                    guests.value = guests.value.filter(g => g.id !== id); 
                    nextTick(() => lucide.createIcons());
                }
            };
            
            const addCategory = () => {
                const input = document.getElementById('catInput');
                if (input.value && !categories.value.includes(input.value)) {
                    categories.value.push(input.value);
                    input.value = '';
                }
            };

            const removeCategory = (cat) => { 
                categories.value = categories.value.filter(c => c !== cat); 
                if (dbFilter.value === cat) dbFilter.value = 'all';
            };

            const exportToPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text(`LAPORAN BUKU TAMU: ${weddingInfo.mempelai}`, 14, 15);
                doc.setFontSize(10);
                doc.text(`Dicetak: ${new Date().toLocaleString('id-ID')} | Total: ${guests.value.length} Tamu`, 14, 22);
                
                doc.setFontSize(12);
                doc.text(`RINGKASAN JUMLAH PER KATEGORI`, 14, 32);
                
                const summaryBody = statsPerCategory.value.map(s => [s.name, s.count]);
                summaryBody.push(['TOTAL KESELURUHAN', guests.value.length]);

                doc.autoTable({
                    startY: 37,
                    head: [['Nama Kategori', 'Jumlah Tamu']],
                    body: summaryBody,
                    theme: 'grid',
                    headStyles: { fillColor: [71, 85, 105], fontStyle: 'bold' },
                    footStyles: { fillColor: [241, 245, 249], textColor: [0, 0, 0], fontStyle: 'bold' }
                });

                let finalY = doc.lastAutoTable.finalY + 15;

                doc.setFontSize(12);
                doc.text(`DAFTAR KEDATANGAN TAMU`, 14, finalY);
                doc.autoTable({
                    startY: finalY + 5,
                    head: [['No', 'Waktu', 'Nama Tamu', 'Kategori', 'WhatsApp']],
                    body: guests.value.map((g, i) => [i + 1, g.time, g.nama, g.kategori, g.hp]),
                    headStyles: { fillColor: [51, 65, 85] }
                });

                doc.save(`Laporan_Wedding_${weddingInfo.mempelai.replace(/\s/g, '_')}.pdf`);
            };

            onMounted(() => {
                loadGuests(); // Ambil data saat web dibuka
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('mode') === 'checkin') {
                    isSelfCheckIn.value = true;
                }
                lucide.createIcons();
            });

            watch(activeTab, (val) => {
                if (val === 'registrasi') generateQRCode();
                nextTick(() => lucide.createIcons());
            });

            return {
                activeTab, dbFilter, regFilter, guests, maxGuests, currentTheme, categories, form,
                weddingInfo, themeOptions, theme, statsPerCategory, filteredGuests, paginatedRegGuests,
                showNotification, isSelfCheckIn, submitGuest, deleteGuest, addCategory, 
                removeCategory, exportToPDF
            }
        }
    }).mount('#app');
</script>

</body>
</html>